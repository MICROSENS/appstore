AirHandleUnit:Adjust_Diagram_Limits "OutsiteTemp"
# AirHandleUnit
# admin, last change: 2025-03-24 13:45:17

gosub Adjust_Diagram_Limits OutsiteTemp

Sub AHUAutoMan
  echo console on
  dump event

  gosub ReadConfig "BTN_ClimateOnOff" 1 return $auto
  gosub ReadConfig "BTN_ClimateOnOff" 2 return $man

  console "Read Config GUI Element - Auto Attribut " $auto
  console "Read Config GUI Element - Manual Attribut " $man


  $BTN_Climate = "BTN_ClimateONOff:1:BUTTON"

  read gui $ClimateONOff $BTN_Climate

  if $ClimateONOff = $auto
    gosub SetAuto 1
  elseif $ClimateONOff = $man then
    gosub SetMan 1
  else
    console "Fehler in der Config"
  endif

  dump var
  
endsub

Sub SetMan $Zone
  App.smartdirector.climate_config[{$Zone}].manual_override = Enabled
  gosub GUItoValve $Zone

endSub

Sub SetAuto $Zone
  App.smartdirector.climate_config[{$Zone}].manual_override = Disable

endSub

Sub ReadConfig $GUIElement $Element

  Management.web.gui_element[{$GUIElement}].value %
  $Read={$cli}
  
  replace $Read= $Read, ":", "," , 1, All
  list get $ReadElement = $Read, $Element

endsub $ReadElement

sub GUItoValve $Zone
  read gui $ValvePerc "SLD_CoolingValve:1:SLIDER"
  App.smartdirector.climate_config[{$Zone}].manual_cooling_value = {$ValvePerc}

  read gui $ValvePerc "SLD_HeaterValve:1:SLIDER"
  App.smartdirector.climate_config[{$Zone}].manual_heating_value = {$ValvePerc}

endsub

Sub Scheduler $SwitchTo
  write gui $SwitchTo "BTN_ClimateMode_1:1:BUTTON"
  echo console on
  dump event
  dump var

endsub

Sub Adjust_Diagram_Limits $Table
  gosub GetExtremes $Table return $Min $Max
  gosub WriteConfig "DIA_OutsideTemp_Day" $Min $Max

endsub

sub GetExtremes $Table
  Management.logging.history_records[{$Table}].last_day %
  string $ValueList "{$cli}"
 
  $Max=0
  $Min=100
  loop $Val for each item of list $ValueList
      intval $CheckVal $Val
      # dump $CheckVal
      if $CheckVal>$Max then $Max=$CheckVal
      if $CheckVal<$Min then $Min=$CheckVal
  endloop
endsub $Min $Max

sub WriteConfig $Element $Min $Max
  echo console on
  if $Min >0 then $Min=0
  if $Max <0 then $Max=0
  append $Value=$Min + ", " + $Max
  Management.web.gui_element[{$Element}].value = {$Value}
  dump var

endSub
