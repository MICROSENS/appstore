# PanicLight
# admin, last change: 2025-08-06 09:14:51

echo console on
gosub PanicButton 1 return $val
console $val

register sensor "Panic:1:Delay" 0 "sec"

sub PanicButton $Zone
    $groupname = Button_{$Zone}
    read sensorgroup $val $groupname
    replace $val=$val "[" "" 1 E
    replace $val=$val "]" "" 1 E
    echo console on
    select $val
    case "on","On","ON","oN"
        $val=1
        console "Val =1 "
    case "off","Off","oFf","ofF","OFf","OfF","OFF"
        $val=0
        console "Val =0 "
    case *
        $val=0
        console "Anything else"
    endselect

    $groupname = ButtonLight_{$Zone}
    write actorgroup $val $groupname
    $on=1000
    $off=0
    if $val <> 0
    # hier müsste eigentlich "activate Scene All Off" stehen, um alles abzuschalten
        write actorgroup $off Dimlevel_Zone_1
        write actorgroup $on Panic_Light
    else
    # hier müsste eigentlich "active Scene Auto" stehen, um wieder in den normalen Modus zurück zu gehen
        write actorgroup $on Dimlevel_Zone_1
        write actorgroup $off Panic_Light
    endif
endsub $val

sub checkUpTime $Zone
    persistent $LastUptime = 0
    register sensor "Panic:1:Delay" 0 "sec"
    $on=1000
    $off=0

    stop timer "CheckDevice"

    $Uptime = 0

    read sensor $Uptime "Panic:1:Uptime"
    replace $Uptime=$Uptime "[" "" 1 E
    replace $Uptime=$Uptime "]" "" 1 E
    


    read sensor $Delay "Panic:1:Delay"

    if $Uptime > $LastUptime
        $LastUptime = $Uptime
        $val = 0
        write sensor $val "Panic:1:Delay"
    elseif $Uptime < 10
        $LastUptime = $Uptime
        $val = 0
        write sensor $val "Panic:1:Delay"
    else
        read sensor $val "Panic:1:Delay"
        $val = $val + 1
        write sensor $val "Panic:1:Delay"
    endif

    read sensor $val "Panic:1:Delay"

    $groupname = Button_{$Zone}
    read sensorgroup $Button $groupname
    replace $Button=$Button "[" "" 1 E
    replace $Button=$Button "]" "" 1 E

    if $val > 10
        write actorgroup $off Dimlevel_Zone_1
        write actorgroup $on Panic_Light
    elseif  $Button = "OFF"
        write actorgroup $on Dimlevel_Zone_1
        write actorgroup $off Panic_Light
    endif

    start timer "CheckDevice" in "1s" {$filename}:checkUpTime
endsub
